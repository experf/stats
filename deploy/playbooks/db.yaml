---
- name: >-
    Deploy stats database
  hosts: db
  become: true
  become_user: root
  
  roles:
    - role: nrser.nansi.postgres
  
  tasks:
    - name: Make sure psycopg2 is installed
      apt:
        name: python3-psycopg2
        state: present
  
    - name: >-
        Create app user `{{ APP_USER }}`
      user:
        name: "{{ APP_USER }}"
        state: present
        create_home: false
        shell: /bin/bash
  
    - name: "Create `{{ DB_NAME }}` database"
      become: true
      become_user: postgres
      postgresql_db:
        name: "{{ DB_NAME }}"
    
    - name: "Add user `{{ APP_USER }}` to database `{{ DB_NAME }}`"
      become: true
      become_user: postgres
      postgresql_user:
        db: "{{ DB_NAME }}"
        name: "{{ APP_USER }}"
        password: "{{ DB_PASSWORD }}"
        priv: ALL
  
    - name: "Ensure user `{{ APP_USER }}` does not have unnecessary privilege"
      become: true
      become_user: postgres
      postgresql_user:
        name: "{{ APP_USER }}"
        role_attr_flags: NOSUPERUSER,NOCREATEDB
    
    - name: "Ensure no other user can access the `{{ DB_NAME }}` database"
      become: true
      become_user: postgres
      postgresql_privs:
        db: "{{ DB_NAME }}"
        role: PUBLIC
        type: database
        priv: ALL
        state: absent
    